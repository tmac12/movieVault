# Ralph Progress Log
# Project: MovieVault v1.2 Scanner Overhaul
# Branch: ralph/v1.2-scanner-overhaul
# Started: 2026-01-30
# ---

## 2026-02-02: US-001 - Add GetMovieByID method to TMDB client

### What was done:
- Added `GetMovieByID(tmdbID int) (*writer.Movie, error)` method to `internal/metadata/tmdb.go`
- Method directly calls TMDB `/movie/{id}` endpoint (via existing `GetMovieDetails`) bypassing search
- Fetches credits via existing `GetMovieCredits` call
- Returns fully populated `*writer.Movie` struct matching `GetFullMovieData` output format
- Added `ErrMovieNotFound` sentinel error for proper 404 handling
- Fixed pre-existing lint issue in `cmd/scanner/main.go` (redundant newline in fmt.Println)

### Files modified:
- `internal/metadata/tmdb.go` - Added GetMovieByID method and ErrMovieNotFound error
- `cmd/scanner/main.go` - Fixed lint issue (unrelated to US-001 but blocked tests)

### Verification:
- `go build ./...` - passes
- `go test ./...` - passes (no test files exist yet)
- `go vet ./...` - passes

### Notes for next developer:
- US-002 is the logical next step - it will integrate GetMovieByID into the scanner's NFO processing flow
- The method reuses existing GetMovieDetails and GetMovieCredits methods to maintain consistency
- ErrMovieNotFound can be checked with `errors.Is(err, metadata.ErrMovieNotFound)` for fallback logic

## 2026-02-02: US-002 - Use TMDB ID from NFO for direct lookup

### What was done:
- Modified `cmd/scanner/main.go` to use direct TMDB ID lookup when NFO contains a valid TMDBID
- Added `errors` import for proper sentinel error checking
- When NFO contains TMDBID > 0, calls `GetMovieByID` instead of `GetFullMovieData`
- If `GetMovieByID` returns 404 error (checked via `errors.Is(err, metadata.ErrMovieNotFound)`), falls back to title/year search
- If TMDBID is 0 or missing, uses existing title/year search behavior
- Added verbose logging for TMDB lookup method ("direct ID", "search", "search (fallback from direct)")

### Files modified:
- `cmd/scanner/main.go` - Added TMDB ID direct lookup integration with NFO processing

### Verification:
- `go build ./...` - passes
- `go test ./...` - passes (no test files exist yet)
- `go vet ./...` - passes
- Note: npm typecheck/test not available in website - environmental esbuild ARM64 compatibility issue unrelated to Go code changes

### Notes for next developer:
- US-003 (Add retry package with exponential backoff) is the next logical step
- The direct lookup improves metadata accuracy by avoiding title search ambiguity when TMDB ID is known
- Verbose mode now shows which lookup method was used for debugging
- The mergeMovieData function is still used to combine NFO data with TMDB data (NFO takes priority)

## 2026-02-02: US-003 - Add retry package with exponential backoff

### What was done:
- Created `internal/retry/retry.go` package with reusable retry utility
- Implemented `Retry(fn func() error, maxAttempts int, initialBackoff time.Duration) error`
  - Executes function with exponential backoff until success or maxAttempts reached
  - Backoff doubles after each failed attempt
  - Rate-limited errors (429) use 2x longer backoff
  - Non-retryable errors (401, 404) return immediately without retry
- Implemented `IsRetryable(err error) bool` helper that returns true for:
  - `net.Error` timeouts (via `errors.As`)
  - `url.Error` timeouts (via `errors.As`)
  - HTTP 5xx status codes (500, 501, 502, 503, 504)
  - Common transient error messages (connection reset, connection refused, no such host, i/o timeout, temporary failure)
- Implemented `IsRateLimited(err error) bool` helper that returns true for HTTP 429 errors

### Files created:
- `internal/retry/retry.go` - New retry package with exponential backoff

### Verification:
- `go build ./...` - passes
- `go test ./...` - passes (no test files exist yet)
- `go vet ./...` - passes
- Note: npm build has esbuild ARM64 compatibility issue unrelated to Go code changes

### Notes for next developer:
- US-004 (Add retry config options) is the next logical step - it will add config struct fields
- US-005 will then integrate this retry logic into the TMDB client
- The retry package uses error string matching for HTTP status codes since TMDB client wraps errors with fmt.Errorf
- Consider adding structured error types in future for better error classification

## 2026-02-02: US-004 - Add retry config options

### What was done:
- Added `RetryConfig` struct to `internal/config/config.go` with two fields:
  - `MaxAttempts int` (yaml: `max_attempts`)
  - `InitialBackoffMs int` (yaml: `initial_backoff_ms`)
- Added `Retry` field to main `Config` struct
- Added default values in `Load()` function:
  - `MaxAttempts` defaults to 3
  - `InitialBackoffMs` defaults to 1000
- Updated `config/config.example.yaml` with retry section and descriptive comments

### Files modified:
- `internal/config/config.go` - Added RetryConfig struct and defaults
- `config/config.example.yaml` - Added retry section with documentation

### Verification:
- `go build ./...` - passes
- `go test ./...` - passes (no test files exist yet)
- `go vet ./...` - passes

### Notes for next developer:
- US-005 (Integrate retry logic into TMDB client) is the next logical step
- The config values can be accessed via `cfg.Retry.MaxAttempts` and `cfg.Retry.InitialBackoffMs`
- Convert `InitialBackoffMs` to `time.Duration` when passing to retry.Retry(): `time.Duration(cfg.Retry.InitialBackoffMs) * time.Millisecond`
- The TMDB client will need to accept config or retry parameters to use these values

